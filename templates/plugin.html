{% extends "base.html" %}
{% block content %}

<div class="container-fluid py-4">
  <div class="row">
    <!-- Sidebar: Simulation Controls -->
    <div class="col-lg-3">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="fas {{ plugin.icon }} me-2"></i>
            {{ plugin.name }}
          </h5>
        </div>
        <div class="card-body">
          <p class="text-muted mb-4">{{ plugin.description }}</p>
          
          <form method="post" id="simulation-form" class="needs-validation" novalidate>
            {% for param in plugin.parameters %}
              <div class="mb-3">
                <label for="{{ param.name }}" class="form-label">
                  {{ param.description }}
                </label>
                
                {% if param.type == "float" %}
                  <div class="input-group">
                    <input type="range" class="form-range w-75" 
                           id="{{ param.name }}_range" 
                           min="0" max="{% if param.name == 'noise' %}0.2{% else %}1{% endif %}" 
                           step="0.01" 
                           value="{{ param.default }}"
                           aria-label="{{ param.description }} slider">
                    <input type="number" class="form-control w-25" 
                           name="{{ param.name }}" 
                           id="{{ param.name }}" 
                           value="{{ param.default }}"
                           step="0.01"
                           min="0"
                           aria-label="{{ param.description }} value"
                           required>
                  </div>
                {% elif param.type == "int" %}
                  <input type="number" class="form-control" 
                         name="{{ param.name }}" 
                         id="{{ param.name }}" 
                         value="{{ param.default }}"
                         min="1"
                         aria-label="{{ param.description }}"
                         required>
                {% else %}
                  <input type="{{ 'text' if param.type == 'str' else param.type }}" 
                         class="form-control"
                         name="{{ param.name }}" 
                         id="{{ param.name }}" 
                         value="{{ param.default }}"
                         aria-label="{{ param.description }}"
                         required>
                {% endif %}
                
                <div class="form-text">
                  {{ param.type }} {% if param.min is defined %}(min: {{ param.min }}){% endif %}
                </div>
              </div>
            {% endfor %}
            
            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary" id="run-simulation">
                <i class="fas fa-play me-2"></i> Run Simulation
              </button>
              <button type="button" class="btn btn-outline-secondary" id="reset-form">
                <i class="fas fa-undo me-2"></i> Reset Parameters
              </button>
            </div>
          </form>
        </div>
      </div>
      
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-dark text-white">
          <h5 class="mb-0">Navigation</h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
              <i class="fas fa-home me-2"></i> Back to Home
            </a>
            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#helpModal">
              <i class="fas fa-question-circle me-2"></i> Documentation
            </button>
            <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#learningModal">
              <i class="fas fa-graduation-cap me-2"></i> Learning Center
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Main Content: Simulation Results -->
    <div class="col-lg-9">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center bg-dark text-white">
          <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i> Simulation Results</h5>
          <div class="simulation-status">
            <span class="badge bg-secondary" id="status-badge">Ready</span>
          </div>
        </div>
        <div class="card-body" id="results-container">
          {% if not result %}
            <div class="text-center py-5 text-muted">
              <i class="fas fa-atom fa-3x mb-3"></i>
              <h4>Quantum Simulation</h4>
              <p>Configure parameters and run the simulation to see results.</p>
            </div>
          {% endif %}
          
          {% if result %}
            {% if result.error %}
              <div class="alert alert-danger">
                <h5 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i> Error Occurred</h5>
                <hr>
                <pre class="mt-3 mb-0">{{ result.error }}</pre>
              </div>
            {% else %}
              <div class="result-container">
                <!-- Visualization tabs -->
                <ul class="nav nav-tabs" id="resultTabs" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="visualization-tab" data-bs-toggle="tab" 
                            data-bs-target="#visualization" type="button" role="tab" 
                            aria-controls="visualization" aria-selected="true">
                      <i class="fas fa-chart-bar me-2"></i> Visualization
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="raw-data-tab" data-bs-toggle="tab" 
                            data-bs-target="#raw-data" type="button" role="tab" 
                            aria-controls="raw-data" aria-selected="false">
                      <i class="fas fa-table me-2"></i> Raw Data
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="log-tab" data-bs-toggle="tab" 
                            data-bs-target="#log" type="button" role="tab" 
                            aria-controls="log" aria-selected="false">
                      <i class="fas fa-terminal me-2"></i> Process Log
                    </button>
                  </li>
                </ul>
                
                <div class="tab-content p-3 border border-top-0 rounded-bottom" id="resultTabsContent">
                  <!-- Visualization Tab -->
                  <div class="tab-pane fade show active" id="visualization" role="tabpanel" aria-labelledby="visualization-tab">
                    {% if result.output is mapping and result.output.circuit_svg %}
                    <h5 class="mb-3">Circuit Diagram</h5>
                    <div class="circuit-svg-wrapper">
                      <div class="circuit-svg bg-white p-3 rounded mb-4 text-center">
                        {{ result.output.circuit_svg | safe }}
                      </div>
                    </div>
                  {% endif %}
                    
                    <!-- Specific visualizations based on plugin type -->
                    <div class="row">
                      {% if plugin.key == 'qrng' or plugin.key == 'bb84' %}
                        <div class="col-md-6 mb-4">
                          <div class="card">
                            <div class="card-header">Bit Distribution</div>
                            <div class="card-body">
                              <canvas id="bit-distribution-chart" class="chart-container"></canvas>
                            </div>
                          </div>
                        </div>
                      {% endif %}
                      
                      {% if plugin.key == 'teleport' or plugin.key == 'handshake' or plugin.key == 'auth' %}
                        <div class="col-md-6 mb-4">
                          <div class="card">
                            <div class="card-header">Quantum State</div>
                            <div class="card-body">
                              <div id="quantum-state-viz" class="chart-container"></div>
                            </div>
                          </div>
                        </div>
                      {% endif %}
                      
                      {% if plugin.key == 'grover' or plugin.key == 'quantum_decryption_grover' %}
                        <div class="col-md-6 mb-4">
                          <div class="card">
                            <div class="card-header">Probability Distribution</div>
                            <div class="card-body">
                              <canvas id="probability-distribution" class="chart-container"></canvas>
                            </div>
                          </div>
                        </div>
                      {% endif %}
                      
                      {% if plugin.key == 'vqe' %}
                        <div class="col-md-6 mb-4">
                          <div class="card">
                            <div class="card-header">Energy Convergence</div>
                            <div class="card-body">
                              <canvas id="energy-convergence" class="chart-container"></canvas>
                            </div>
                          </div>
                        </div>
                      {% endif %}

                      {% if plugin.key == 'deutsch_jozsa' %}
                        <div class="col-md-6 mb-4">
                          <div class="card">
                            <div class="card-header">Deutsch-Jozsa Results</div>
                            <div class="card-body">
                              <div id="deutsch-jozsa-viz" class="chart-container"></div>
                            </div>
                          </div>
                        </div>
                      {% endif %}

                      {% if plugin.key == 'qft' %}
                        <div class="col-md-6 mb-4">
                          <div class="card">
                            <div class="card-header">QFT Transformation</div>
                            <div class="card-body">
                              <div id="qft-state-viz" class="chart-container"></div>
                            </div>
                          </div>
                        </div>
                      {% endif %}

                      {% if plugin.key == 'phase_estimation' %}
                        <div class="col-md-6 mb-4">
                          <div class="card">
                            <div class="card-header">Phase Estimation</div>
                            <div class="card-body">
                              <div id="phase-estimation-viz" class="chart-container"></div>
                            </div>
                          </div>
                        </div>
                      {% endif %}

                      {% if plugin.key == 'qaoa' %}
                        <div class="col-md-6 mb-4">
                          <div class="card">
                            <div class="card-header">MaxCut Graph Visualization</div>
                            <div class="card-body">
                              <div id="qaoa-graph-viz" class="chart-container"></div>
                            </div>
                          </div>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                  
                  <!-- Raw Data Tab -->
                  <div class="tab-pane fade" id="raw-data" role="tabpanel" aria-labelledby="raw-data-tab">
                    <div class="row">
                      {% if result.output is mapping %}
                        {% for key, value in result.output.items() %}
                          {% if key != 'circuit_svg' %}
                            <div class="col-md-6 mb-4">
                              <div class="card">
                                <div class="card-header">{{ key | replace('_', ' ') | title }}</div>
                                <div class="card-body">
                                  <pre class="mb-0">{{ value | pprint }}</pre>
                                </div>
                              </div>
                            </div>
                          {% endif %}
                        {% endfor %}
                      {% else %}
                        <div class="col-12">
                          <pre class="mb-0">{{ result.output | pprint }}</pre>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                  
                  <!-- Log Tab -->
                  <div class="tab-pane fade" id="log" role="tabpanel" aria-labelledby="log-tab">
                    <div class="bg-dark text-light p-3 rounded">
                      <pre class="mb-0 terminal-log">{{ result.log }}</pre>
                    </div>
                  </div>
                </div>
              </div>
            {% endif %}
          {% endif %}
        </div>
      </div>
      
      <!-- Quantum Explanation Card (Mini Version) -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="fas fa-graduation-cap me-2"></i> Quantum Explanation</h5>
          <button class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#learningModal">
            <i class="fas fa-expand me-1"></i> Learn More
          </button>
        </div>
        <div class="card-body">
          {% if plugin.key == 'bb84' %}
            <h5>BB84: Quantum Key Distribution</h5>
            <p>BB84 is the first quantum cryptography protocol, developed by Charles Bennett and Gilles Brassard in 1984. It allows two parties to establish a shared secret key using quantum communication.</p>
            <div class="alert alert-primary">
              <strong>Key Quantum Concept:</strong> The security of BB84 relies on the <em>no-cloning theorem</em> and the fact that measuring a quantum state disturbs it in a detectable way.
            </div>
            
          {% elif plugin.key == 'teleport' %}
            <h5>Quantum Teleportation</h5>
            <p>Quantum teleportation is a technique for transferring a quantum state from one location to another using quantum entanglement and classical communication.</p>
            <div class="alert alert-primary">
              <strong>Key Quantum Concept:</strong> Teleportation doesn't move the physical particle itself, but rather transfers its quantum state to another pre-existing particle through entanglement.
            </div>
            
          {% elif plugin.key == 'grover' %}
            <h5>Grover's Search Algorithm</h5>
            <p>Grover's algorithm provides a quadratic speedup for unstructured search problems, finding a marked item in a database of N items with approximately âˆšN queries.</p>
            <div class="alert alert-primary">
              <strong>Key Quantum Concept:</strong> Utilizes quantum superposition and amplitude amplification to enhance the probability of measuring the correct answer.
            </div>
            
          {% elif plugin.key == 'handshake' %}
            <h5>Quantum Handshake Protocol</h5>
            <p>A quantum handshake uses entangled particles to establish a secure connection between two parties that can detect any eavesdropping attempts.</p>
            <div class="alert alert-primary">
              <strong>Key Quantum Concept:</strong> Relies on quantum entanglement to create correlations between particles that would be impossible to achieve classically.
            </div>
            
          {% elif plugin.key == 'auth' %}
            <h5>Quantum Authentication</h5>
            <p>Quantum authentication uses quantum fingerprinting to verify the identity of a user without exposing the actual authentication token.</p>
            <div class="alert alert-primary">
              <strong>Key Quantum Concept:</strong> The no-cloning theorem ensures authentication tokens cannot be perfectly copied, providing enhanced security.
            </div>
            
          {% elif plugin.key == 'network' %}
            <h5>Entanglement Swapping Network</h5>
            <p>Entanglement swapping allows quantum nodes to establish entanglement between remote particles that have never directly interacted.</p>
            <div class="alert alert-primary">
              <strong>Key Quantum Concept:</strong> Enables long-distance quantum communication by extending entanglement across a network of quantum repeaters.
            </div>
            
          {% elif plugin.key == 'qrng' %}
            <h5>Quantum Random Number Generator</h5>
            <p>QRNGs produce true random numbers based on inherently random quantum processes, unlike classical random number generators which are typically deterministic.</p>
            <div class="alert alert-primary">
              <strong>Key Quantum Concept:</strong> Leverages the fundamental randomness of quantum measurement outcomes to generate unpredictable numbers.
            </div>
            
          {% elif plugin.key == 'shor' %}
            <h5>Shor's Code for Quantum Error Correction</h5>
            <p>Shor's code is a quantum error correction technique that protects quantum information against both bit-flip and phase-flip errors.</p>
            <div class="alert alert-primary">
              <strong>Key Quantum Concept:</strong> Encodes a single logical qubit into nine physical qubits to detect and correct errors without disturbing the quantum state.
            </div>
            
          {% elif plugin.key == 'vqe' %}
            <h5>Variational Quantum Eigensolver</h5>
            <p>VQE is a hybrid quantum-classical algorithm designed to find ground state energies of complex quantum systems like molecules.</p>
            <div class="alert alert-primary">
              <strong>Key Quantum Concept:</strong> Uses parameterized quantum circuits optimized by classical algorithms to approximate quantum states efficiently.
            </div>
            
          {% elif plugin.key == 'quantum_decryption_grover' %}
            <h5>Quantum Decryption via Grover's Algorithm</h5>
            <p>This application of Grover's algorithm demonstrates how quantum computing could potentially break certain types of encryption by efficiently searching for keys.</p>
            <div class="alert alert-primary">
              <strong>Key Quantum Concept:</strong> Provides a quadratic speedup over classical brute-force approaches to key finding.
            </div>
            
          {% elif plugin.key == 'quantum_decryption_shor' %}
            <h5>Quantum Decryption via Shor's Algorithm</h5>
            <p>Shor's algorithm can efficiently factor large numbers, threatening cryptosystems like RSA that rely on the difficulty of factoring.</p>
            <div class="alert alert-primary">
              <strong>Key Quantum Concept:</strong> Uses quantum Fourier transform to find the period of a function, enabling efficient factorization of large numbers.
            </div>
            
          {% else %}
            <h5>{{ plugin.name }}</h5>
            <p>This simulation demonstrates key quantum computing concepts including superposition, entanglement, and measurement.</p>
            <div class="alert alert-primary">
              <strong>Key Quantum Concept:</strong> Quantum simulations provide insight into quantum behavior without requiring actual quantum hardware.
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Help Modal -->
<div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title" id="helpModalLabel">
          <i class="fas fa-question-circle me-2"></i> {{ plugin.name }} Documentation
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <h5>Parameters</h5>
            <dl>
              {% for param in plugin.parameters %}
                <dt>{{ param.name }}</dt>
                <dd>{{ param.description }} <span class="badge bg-secondary">{{ param.type }}</span></dd>
              {% endfor %}
            </dl>
          </div>
          <div class="col-md-6">
            <h5>Output</h5>
            <p>The simulation produces:</p>
            <ul>
              {% if plugin.key == 'bb84' %}
                <li>Shared key between Alice and Bob</li>
                <li>Information about bases used</li>
                <li>Quantum circuit diagram</li>
              {% elif plugin.key == 'teleport' %}
                <li>Final quantum state after teleportation</li>
                <li>Measurement outcomes</li>
                <li>Quantum circuit diagram</li>
              {% elif plugin.key == 'grover' %}
                <li>Search outcome (target state)</li>
                <li>Probability distribution</li>
                <li>Quantum circuit diagram</li>
              {% else %}
                <li>Simulation results specific to this quantum protocol</li>
                <li>Quantum state information</li>
                <li>Detailed process log</li>
              {% endif %}
              <li>Downloadable circuit diagram in SVG format</li>
            </ul>
          </div>
        </div>
        <hr>
        <h5>How It Works</h5>
        <p>This simulation uses Google Cirq, a Python framework for creating, editing, and invoking Noisy Intermediate Scale Quantum (NISQ) circuits. The backend performs these steps:</p>
        <ol>
          <li>Constructs quantum circuit based on your parameters</li>
          <li>Applies specified quantum gates and operations</li>
          <li>Simulates quantum behavior with high fidelity</li>
          <li>Performs measurements and collects results</li>
          <li>Renders visualizations of the quantum behavior</li>
        </ol>
        <p>You can download the quantum circuit diagram as an SVG file by clicking the download button that appears in the top-right corner of the circuit visualization.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Learning Center Modal-->
<div class="modal fade" id="learningModal" tabindex="-1" aria-labelledby="learningModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="learningModalLabel">
          <i class="fas fa-graduation-cap me-2"></i> Quantum Learning Center: {{ plugin.name }}
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Include the appropriate educational content template based on plugin key -->
        {% include educational_template %}
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
<script src="{{ url_for('static', filename='js/OrbitControls.js') }}"></script>
<script src="{{ url_for('static', filename='js/quantum_visualizations.js') }}"></script>
<script src="{{ url_for('static', filename='js/plugin_visualizations.js') }}"></script>

<script>
  // Pass plugin data to the visualization module
  document.addEventListener('DOMContentLoaded', function() {
    {% if result and not result.error %}
      // Initialize visualizations with plugin data
      QuantumVisualizer.init('{{ plugin.key }}', {{ result|tojson }});
      
      // Initialize circuit download buttons
      addCircuitDownloadButtons();
    {% endif %}
  });
</script>
{% endblock %}